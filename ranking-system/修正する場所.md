# Google Apps Scriptの修正

## Code.gsの修正
1. 現在ranking-systemに入っているコードを全行コピー
2. 下記にスプレッドシートのURLの下記の部分を入れる

URLがこんな感じなら
https://docs.google.com/spreadsheets/d/123456xxxxxxxxxxxxxxxxxxxxxxxxx/edit?gid=0#gid=0

こんな感じにする
```javascript
const SPREADSHEET_ID = '123456xxxxxxxxxxxxxxxxxxxxxxxxx';
```

## Validation.gsを追加
- これがしてないので、投稿時にエラーになっていた
- Apps Scriptのエディタを開いて、右側のファイルの＋を押す
- 名前に`Validation`と入れる。.gsは不要。
- ranking-system内のValidation.gsをコピペ

![alt text](2025-09-02_22h03_48.png)

## デプロイする
URLをコピーしておく
https://script.google.com/macros/s/AKfycbx_YtnS3e_oqr2gQsWTmJqu1jsm-_d_r7yeCUnwUYv-8sMVrMB2dtEFcodgivtO8kEB/exec

## 確認
ちゃんと読み書きできるかを確認

### 取得
curl -L "https://script.google.com/macros/s/xxxxxxxxxxxxx/exec"

上手くいくと
```json
{"top5":[{"score":"score","name":"name","date":"date"},{"score":50,"name":"abc","date":"2025-09-02T12:42:23.000Z"},{"score":30,"name":"test2","date":"2025-09-02T12:42:57.000Z"},{"score":10,"name":"testuser","date":"2025-09-02T12:40:22.000Z"},{"score":10,"name":"testuser","date":"2025-09-02T12:39:26.000Z"}]}
```

### 書き込み
curl -L "https://script.google.com/macros/s/xxxxxxxxxxxx/exec?action=post&score=1000&name=testuser&callback=callback"

上手くいくと
```json
callback({"success":true,"message":"ランキングに登録されました","rank":3});
```


# ゲーム側の修正

## main.jsの修正

下記のURLをデプロイしたやつに変更
```javascript
        // ランキングシステムの初期化
        this.rankingApiUrl = 'https://script.google.com/macros/s/xxxxxxxxxx/exec';
```


## rankingManager.jsの修正

validateRankingDataと、normalizeRankingDataのみ下記に変更

```javascript
    /**
     * ランキングデータの形式を検証
     * @param {Object} data - APIレスポンスデータ
     * @return {boolean}
     */
    validateRankingData(data) {
        if (!data || typeof data !== 'object') {
            return false;
        }

        // top5形式の検証
        if (data.top5 && Array.isArray(data.top5)) {
            // 1番目がヘッダーの場合は除外
            const top5 = data.top5;
            const startIdx = (typeof top5[0].score === 'string' && typeof top5[0].name === 'string') ? 1 : 0;
            return top5.slice(startIdx).every(item => 
                item && 
                typeof item.score === 'number' && 
                typeof item.name === 'string' && 
                typeof item.date === 'string'
            );
        }

        // ranking形式の検証
        if (data.ranking && Array.isArray(data.ranking)) {
            return data.ranking.every(item => 
                item && 
                typeof item.rank === 'number' && 
                typeof item.score === 'number' && 
                typeof item.name === 'string'
            );
        }

        return false;
    }

    /**
     * ランキングデータを正規化
     * @param {Object} data - 生のAPIレスポンス
     * @return {Object} 正規化されたランキングデータ
     */
    normalizeRankingData(data) {
        let ranking = [];

        if (data.top5) {
            // top5形式を正規化（ヘッダー除外）
            const top5 = data.top5;
            const startIdx = (typeof top5[0].score === 'string' && typeof top5[0].name === 'string') ? 1 : 0;
            ranking = top5.slice(startIdx).map((item, index) => ({
                rank: index + 1,
                score: item.score,
                name: item.name,
                date: new Date(item.date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric'
                })
            }));
        } else if (data.ranking) {
            // ranking形式はそのまま使用（日付フォーマットのみ調整）
            ranking = data.ranking.map(item => ({
                ...item,
                date: item.date ? new Date(item.date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric'
                }) : ''
            }));
        }

        return {
            ranking: ranking,
            lastUpdated: new Date().toISOString(),
            totalPlayers: ranking.length
        };
    }
```

## その他
- 上手く動いたら一旦これでコミットしておく
- ランキング投稿時に出る「あなたの順位は」が１番ずれる。これはAIで修正できそう
- PLAY AGAINが押せない→これもSCOREを消せば何とかなりそうな気がする
