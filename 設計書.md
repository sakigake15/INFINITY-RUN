## JavaScript 3Dゲーム設計書 (Three.js使用) - 更新版

この設計書は、JavaScriptとThree.jsを用いて、3レーンを移動しながら障害物を避ける3Dゲームを開発するためのものです。フェーズ分けを行い、各フェーズのタスクを細かく記述します。

**フェーズ分け (非常に細かい粒度):**

**フェーズ1: プロジェクト初期設定と基本構造の構築 (変更なし)**

1.  **タスク1.1:** HTMLファイルの作成 (index.html)
    *   CDNからThree.jsと必要に応じて他のライブラリを読み込む記述を追加。
    *   ゲームを表示するためのcanvas要素を追加。
    *   CSSファイルを読み込む記述を追加。
2.  **タスク1.2:** CSSファイルの作成 (style.css)
    *   canvas要素のスタイルを設定 (サイズ、配置など)。
    *   必要に応じて、他のUI要素のスタイルを設定。
3.  **タスク1.3:** JavaScriptファイルの作成 (script.js)
    *   Three.jsの基本的なシーン、カメラ、レンダラーを初期化するコードを記述。
    *   レンダリングループを作成 (requestAnimationFrameを使用)。
4.  **タスク1.4:** JavaScriptファイルの分割 (必要に応じて)
    *   コードの規模が大きくなる場合に備え、ファイル分割を検討 (例: scene.js, camera.js, renderer.js, player.js, obstacle.js)。
5.  **タスク1.5:** Gitリポジトリの初期化
    *   ローカルリポジトリを作成し、初期ファイルをコミット。
    *   必要に応じて、GitHubなどのリモートリポジトリに接続。

**フェーズ2: 基本的な3D空間の作成と表示**

1.  **タスク2.1:** レーンの作成
    *   PlaneGeometryを使用して、3つのレーンを作成。
    *   それぞれのレーンに色またはテクスチャを適用。
    *   レーンをシーンに追加。
    *   レーンの配置を設定 (横に並べる)。
2.  **タスク2.2:** カメラの配置
    *   PerspectiveCameraを作成。
    *   カメラの位置を調整 (キャラクターの後ろから見下ろす視点)。
    *   カメラの向きを調整。
3.  **タスク2.3:** ライトの追加
    *   AmbientLight (環境光) を追加して、シーン全体を明るくする。
    *   DirectionalLight (指向光) または PointLight (点光源) を追加して、立体感を出す。
    *   ライトの位置と色を調整。
4.  **タスク2.4:** 背景の作成
    *   シンプルな背景を作成（例：単色のPlaneGeometry）。
    *   背景をシーンに追加。
    *   必要に応じて、背景テクスチャを適用。
5.  **タスク2.5:** レンダリングループの調整
    *   毎フレーム、シーンとカメラをレンダリングするように、レンダリングループを調整。

**フェーズ3: プレイヤーキャラクターの作成と操作**

1.  **タスク3.1:** プレイヤーキャラクターのロード
    *   GLTFLoaderを使用して、プレイヤーキャラクターのGLBファイルをロード。
    *   ロード完了後、モデルをシーンに追加。
    *   モデルのスケール、位置、回転を調整。
2.  **タスク3.2:** キャラクターの移動ロジックの実装
    *   PC環境: キーボード入力 (矢印キー) を検知するリスナーを追加。
    *   スマートフォン環境: タッチイベントを検知するリスナーを追加。
    *   左右のキー (またはスワイプ) が押された場合に、キャラクターの位置を対応するレーンに移動させる関数を作成。
    *   移動速度を設定し、滑らかな移動を実現する。
    *   レーンから外に出ないように、移動範囲を制限する。
3.  **タスク3.3:** PC/スマホの自動切り替え
    *   `navigator.userAgent` を使用して、デバイスの種類を判別。
    *   デバイスの種類に応じて、適切なイベントリスナーを登録する。

**フェーズ4: 障害物の生成と移動**

1.  **タスク4.1:** 障害物のロード
    *   GLTFLoaderを使用して、障害物のGLBファイルをロード。
    *   ロード完了後、モデルをシーンに追加。
    *   モデルのスケール、位置、回転を調整。
2.  **タスク4.2:** 障害物の移動ロジックの実装
    *   障害物を毎フレーム、手前 (カメラに近い方向) に移動させる関数を作成。
    *   移動速度を設定。
    *   障害物が画面外に出たら、削除する。
3.  **タスク4.3:** 障害物の生成ロジックの実装
    *   一定時間ごとに、新しい障害物を生成する関数を作成。
    *   各レーンからランダムに障害物を生成するようにする。
    *   生成間隔をランダムにする。

**フェーズ5: 衝突判定とゲームオーバー処理**

1.  **タスク5.1:** 衝突判定の実装
    *   プレイヤーキャラクターと障害物の位置を比較し、衝突を検知する関数を作成。
    *   Three.jsのBoundingBoxHelperを使用する (オプション、パフォーマンスに注意)。
    *   または、距離計算により簡易的な衝突判定を行う。
2.  **タスク5.2:** ゲームオーバー処理の実装
    *   衝突が検知されたら、ゲームオーバー画面を表示する関数を作成。
    *   レンダリングループを停止する。
    *   ゲームオーバー画面にスコアを表示する。
    *   リトライボタンを追加する (HTML要素)。
    *   リトライボタンがクリックされたら、ゲームをリセットする関数を呼び出す。

**フェーズ6: スコアリングシステム**

1.  **タスク6.1:** スコア変数の作成
    *   スコアを保持するための変数を作成。
    *   スコアを初期化する関数を作成。
2.  **タスク6.2:** スコア加算ロジックの実装
    *   障害物を回避するごとに、スコアを加算する関数を作成。
3.  **タスク6.3:** スコア表示の実装
    *   HTML要素 (例: `<div>`) を使用して、スコアを画面に表示する。
    *   スコアが更新されるたびに、表示を更新する。

**フェーズ7: UI/UXの改善**

1.  **タスク7.1:** タイトル画面の作成
    *   ゲーム開始前に表示するタイトル画面を作成。
    *   ゲームタイトル、操作説明、スタートボタンなどを表示する。
2.  **タスク7.2:** ゲームオーバー画面の改善
    *   ゲームオーバー画面のデザインを改善する。
    *   スコア、リトライボタンを表示する。

**フェーズ8: デバッグと最適化 (変更なし)**

1.  **タスク8.1:** デバッグ
    *   ゲームプレイ中に発生するバグを修正する。
    *   様々なデバイスで動作確認を行う。
2.  **タスク8.2:** パフォーマンス最適化
    *   Three.jsのパフォーマンス最適化に関する情報を参考に、レンダリング負荷を軽減する。
    *   必要に応じて、モデルのポリゴン数を減らすなどの対策を行う。

**フェーズ9: リリース準備 (変更なし)**

1.  **タスク9.1:** ドキュメント作成
    *   ゲームの説明書を作成する。
    *   使用したライブラリ、アセットのライセンス情報を記載する。
2.  **タスク9.2:** ビルド
    *   HTML, CSS, JavaScriptファイルをまとめて、リリース可能な形式にビルドする。
3.  **タスク9.3:** デプロイ
    *   ゲームをWebサーバーにデプロイする。