## JavaScript 3Dゲーム設計書 (Three.js使用) - 更新版

この設計書は、JavaScriptとThree.jsを用いて、3レーンを移動しながら障害物を避ける3Dゲームを開発するためのものです。フェーズ分けを行い、各フェーズのタスクを細かく記述します。

**フェーズ分け (非常に細かい粒度):**

**フェーズ1: プロジェクト初期設定と基本構造の構築【完了】**

1.  **タスク1.1: 完了**
    *   index.htmlファイルを作成
    *   Three.js CDNを追加 (r128)
    *   GLTFLoaderを追加
    *   canvasとscript.jsの読み込みを設定
2.  **タスク1.2: 完了**
    *   style.cssファイルを作成
    *   canvasを全画面表示に設定
    *   ページ全体のスタイルリセットを実装
3.  **タスク1.3: 完了**
    *   script.jsファイルを作成
    *   Three.jsの基本セットアップを実装
    *   レンダリングループを実装
4.  **タスク1.4: 完了**
    *   コードを以下のモジュールに分割:
        - main.js: ゲームの初期化とメインループを管理
        - scene.js: Three.jsのシーン、カメラ、ライト、レーンの設定を担当
        - player.js: プレイヤーキャラクターのロードと動作を制御
        - obstacles.js: 障害物とコインの生成、移動、衝突判定を処理
        - gameState.js: スコア、ゲーム状態、UI関連の処理を管理
        - input.js: キーボードとタッチ入力の処理を担当
    *   各モジュールの責務を明確に分離し、保守性と再利用性を向上
5.  **タスク1.5: 完了**
    *   Gitリポジトリを初期化
    *   .gitignoreファイルを作成
    *   初期ファイルをコミット

**フェーズ2: 基本的な3D空間の作成と表示【完了】**

1.  **タスク2.1: 完了**
    *   PlaneGeometryで3つのレーンを作成（幅2、長さ20）
    *   各レーンに異なる色を適用（緑、青、赤）
    *   レーンを横に並べて配置
2.  **タスク2.2: 完了**
    *   PerspectiveCameraを実装
    *   カメラ位置を設定（高さ3、距離4）
    *   カメラ角度を30度に設定
3.  **タスク2.3: 完了**
    *   AmbientLightを追加（強度0.5）
    *   DirectionalLightを追加（強度0.8）
    *   ライトを右上から当てるように配置
4.  **タスク2.4: 完了**
    *   空色の背景を設定
    *   森林緑の地面（50x50）を作成
    *   地面をレーンの直下に配置
5.  **タスク2.5: 完了**
    *   requestAnimationFrameを使用したレンダリングループを実装

**フェーズ3: プレイヤーキャラクターの作成と操作【完了】**

1.  **タスク3.1: 完了**
    *   GLTFLoaderを使用してRogue.glbをロード
    *   モデルのスケールを0.5に設定
    *   キャラクターを適切な位置（高さ0.3）に配置
2.  **タスク3.2: 完了**
    *   矢印キーによる左右移動を実装
    *   スムーズな移動アニメーションを実装（移動速度0.2）
    *   レーン範囲内（0-2）に移動を制限
3.  **タスク3.3: 完了**
    *   navigator.userAgentでデバイス判定
    *   PC: 矢印キーでの移動
    *   スマートフォン: 50px以上のスワイプで移動

**フェーズ4: 障害物の生成と移動【完了】**

1.  **タスク4.1: 完了**
    *   GLTFLoaderを使用してbarrel_smallをロード
    *   モデルのスケールを1.0に設定
    *   初期位置をz=-15に設定
    *   複数の障害物を配列で管理する仕組みを実装
2.  **タスク4.2: 完了**
    *   障害物の移動速度を0.2に設定
    *   updateObstaclePosition関数で全ての障害物を毎フレーム移動
    *   z>2で画面外と判定して削除する処理を実装
    *   各障害物に対して個別に衝突判定を実行
3.  **タスク4.3: 完了**
    *   spawnObstacle関数で0.5-1秒間隔でランダム生成
    *   3レーンからランダムに配置位置を選択
    *   画面上に複数の障害物が同時に存在可能

**プレイヤーアニメーションの追加**
* AnimationMixerを使用してRunning_Aアニメーションを実装
* 無限ループ設定でキャラクターが常時走るアニメーションを再生

**フェーズ5: アイテムシステムの実装【完了】**

1.  **タスク5.1: コインの生成システム - 完了**
    *   GLTFLoaderを使用してCoin_A.gltfをロード
    *   障害物生成時にコインも同時に生成
    *   障害物とは異なるレーンに配置する処理を実装
    *   複数のコインを配列で管理する仕組みを実装

2.  **タスク5.2: コインの挙動制御 - 完了**
    *   コインのスケールを0.5に設定
    *   地面から浮かせて配置（y=0.5）
    *   障害物と同じ速度で前進
    *   rotation.yを使用して回転アニメーションを実装

3.  **タスク5.3: コインの取得処理 - 完了**
    *   money変数を追加して所持金を管理
    *   コインとプレイヤーの衝突判定を実装
    *   コイン取得時にmoney変数を10増加
    *   コイン取得時に3Dモデルを削除

4.  **タスク5.4: UI表示の実装 - 完了**
    *   HTMLにコイン表示欄を追加
    *   コイン獲得時に表示を更新
    *   ゲームリセット時に表示をクリア

**フェーズ6: 衝突判定とゲームオーバー処理**

1.  **タスク6.1:** 衝突判定の実装
    *   プレイヤーキャラクターと障害物の位置を比較し、衝突を検知する関数を作成。
    *   Three.jsのBoundingBoxHelperを使用する (オプション、パフォーマンスに注意)。
    *   または、距離計算により簡易的な衝突判定を行う。
2.  **タスク6.2:** ゲームオーバー処理の実装
    *   衝突が検知されたら、ゲームオーバー画面を表示する関数を作成。
    *   レンダリングループを停止する。
    *   ゲームオーバー画面にスコアを表示する。
    *   リトライボタンを追加する (HTML要素)。
    *   リトライボタンがクリックされたら、ゲームをリセットする関数を呼び出す。

**フェーズ7: スコアリングシステム**

1.  **タスク7.1:** スコア変数の作成
    *   スコアを保持するための変数を作成。
    *   スコアを初期化する関数を作成。
2.  **タスク7.2:** スコア加算ロジックの実装
    *   障害物を回避するごとに、スコアを加算する関数を作成。
3.  **タスク7.3:** スコア表示の実装
    *   HTML要素 (例: `<div>`) を使用して、スコアを画面に表示する。
    *   スコアが更新されるたびに、表示を更新する。

**フェーズ8: UI/UXの改善**

1.  **タスク8.1:** タイトル画面の作成
    *   ゲーム開始前に表示するタイトル画面を作成。
    *   ゲームタイトル、操作説明、スタートボタンなどを表示する。
2.  **タスク8.2:** ゲームオーバー画面の改善
    *   ゲームオーバー画面のデザインを改善する。
    *   スコア、リトライボタンを表示する。

**フェーズ9: デバッグと最適化 (変更なし)**

1.  **タスク9.1:** デバッグ
    *   ゲームプレイ中に発生するバグを修正する。
    *   様々なデバイスで動作確認を行う。
2.  **タスク9.2:** パフォーマンス最適化
    *   Three.jsのパフォーマンス最適化に関する情報を参考に、レンダリング負荷を軽減する。
    *   必要に応じて、モデルのポリゴン数を減らすなどの対策を行う。

**フェーズ10: リリース準備 (変更なし)**

1.  **タスク10.1:** ドキュメント作成
    *   ゲームの説明書を作成する。
    *   使用したライブラリ、アセットのライセンス情報を記載する。
2.  **タスク10.2:** ビルド
    *   HTML, CSS, JavaScriptファイルをまとめて、リリース可能な形式にビルドする。
3.  **タスク10.3:** デプロイ
    *   ゲームをWebサーバーにデプロイする。
