## JavaScript 3Dゲーム設計書 (Three.js使用) - 最新版

この設計書は、JavaScriptとThree.jsを用いて、3レーンを移動しながら障害物を避ける3Dゲームを開発するためのものです。現在の実装状況を反映し、完了済みのフェーズと進行中のフェーズを明確に記述します。

### プロジェクト概要
- **技術スタック**: JavaScript, Three.js (r128), GLTF Loader
- **ゲームタイプ**: 3Dエンドレスランナー
- **プラットフォーム**: PC・スマートフォン対応
- **特色**: 地上世界と地獄世界の切り替え機能、フィーバータイム、パーティクルエフェクト

---

## フェーズ1: プロジェクト初期設定と基本構造の構築【完了】

### タスク1.1: 基本HTMLとCSS構造の作成【完了】
- **実装内容**:
  - index.html: Three.js CDN (r128) + GLTFLoader
  - style.css: フルスクリーン対応、レスポンシブデザイン
  - title.jpg背景画像の実装

### タスク1.2: モジュール分割設計【完了】
- **実装ファイル構成**:
  ```
  js/
  ├── main.js - ゲームの初期化とメインループ管理
  ├── scene.js - Three.jsシーン、カメラ、ライト、レーン設定
  ├── player.js - プレイヤーキャラクター制御
  ├── obstacles.js - 障害物・アイテム生成と衝突判定
  ├── gameState.js - スコア、ゲーム状態、UI管理
  ├── input.js - PC/モバイル入力処理
  ├── audioManager.js - BGM管理（モバイル対応）
  ├── soundEffectManager.js - 効果音管理（モバイル対応）
  └── particleSystem.js - パーティクルエフェクト
  ```

### タスク1.3: Git管理【完了】
- リポジトリ初期化、.gitignore設定
- GitHub連携: https://github.com/sakigake15/INFINITY-RUN.git

---

## フェーズ2: 基本3D空間とゲームプレイ【完了】

### タスク2.1: 3D環境構築【完了】
- **レーン構造**: 3レーン（幅2、プレイヤー移動範囲）
- **カメラ設定**: PerspectiveCamera（位置調整済み）
- **ライト**: AmbientLight + DirectionalLight
- **背景**: 空色背景、森林緑地面（50x50）

### タスク2.2: プレイヤーキャラクター【完了】
- **モデル**: Rogue.glb（スケール0.5、高さ0.3）
- **アニメーション**: Running_Aの無限ループ再生
- **移動制御**: 
  - PC: 矢印キー
  - モバイル: 50px以上のスワイプ検出
  - スムーズアニメーション（速度0.2）

### タスク2.3: 基本障害物システム【完了】
- **モデル**: barrel_small.gltf（地上）、candleBundle/gravestone/cauldron（地獄）
- **生成システム**: 0.3秒間隔、15%確率（地獄では18%）
- **移動**: プレイヤー相対位置で固定配置
- **衝突判定**: 距離計算による判定（範囲1.0）

---

## フェーズ3: アイテムとスコアシステム【完了】

### タスク3.1: コインシステム【完了】
- **基本コイン**: Coin_A.gltf（回転アニメーション）
- **スコア**: 地上10点、地獄50点
- **生成**: 3マス間隔、障害物のないレーンに配置

### タスク3.2: 特別アイテム【完了】
- **かぼちゃ（地上）**: pumpkinLarge.gltf（10%確率、世界切り替え）
- **キャンディー（地獄）**: lollipopB.gltf（10%確率、世界切り替え）
- **ポーション（地上のみ）**: bottle_A_green.gltf（1%確率、フィーバータイム）

### タスク3.3: フィーバータイムシステム【完了】
- **効果**: 5秒間、全レーンにコイン生成
- **BGM**: 専用フィーバーBGM再生
- **発動**: ポーション取得時

---

## フェーズ4: 二世界システム【完了】

### タスク4.1: 地上世界【完了】
- **ビジュアル**: 標準ライト、緑地面
- **BGM**: chijou.mp3
- **障害物**: barrel_small, detail_rocks_small, detail_treeC
- **特別アイテム**: かぼちゃ、ポーション

### タスク4.2: 地獄世界【完了】
- **ビジュアル**: 赤色照明、暗い地面、カメラ180度回転
- **BGM**: jigoku.mp3
- **障害物**: candleBundle, gravestone, cauldron（生成確率120%）
- **特別アイテム**: キャンディー

### タスク4.3: 世界切り替えシステム【完了】
- **トリガー**: かぼちゃ・キャンディー取得時
- **効果音**: change.mp3
- **視覚効果**: 既存障害物のテクスチャ更新

---

## フェーズ5: UI/UXシステム【完了】

### タスク5.1: ゲーム画面【完了】
- **タイトル画面**: title.jpg背景、GAMESTARTボタン
- **ゲーム中UI**: リアルタイムスコア表示
- **ゲームオーバー画面**: 最終スコア、ハイスコア、PLAY AGAINボタン

### タスク5.2: パーティクルエフェクト【完了】
- **アイテム取得時**: キラキラエフェクト（星型テクスチャ）
- **実装**: ParticleSystem.js、Three.jsパーティクル

---

## フェーズ6: 音響システム【完了】

### タスク6.1: BGMシステム【完了】
- **AudioManager.js**: モバイル対応音声管理
- **BGMリスト**:
  - chijou.mp3: 地上世界BGM
  - jigoku.mp3: 地獄世界BGM
  - fever.mp3: フィーバータイム専用BGM
- **機能**: 世界切り替え時の自動BGM変更、フィーバータイム優先制御

### タスク6.2: 効果音システム【完了】
- **SoundEffectManager.js**: モバイル対応SE管理
- **SEリスト**:
  - coin1.mp3: 地上コイン取得音
  - coin2.mp3: 地獄コイン取得音
  - change.mp3: 世界切り替え音
  - death.mp3: ゲームオーバー音

### タスク6.3: モバイル音声対応【完了】
- **実装内容**:
  - ユーザーインタラクション後の音声初期化
  - Web Audio APIサスペンド状態の解除
  - モバイル端末での音声ファイル事前準備
  - 非同期音声再生とエラーハンドリング

---

## フェーズ7: ゲーム状態管理【完了】

### タスク7.1: GameState.js【完了】
- **スコア管理**: 加算、表示更新、ハイスコア保存
- **ゲーム状態**: 開始、プレイ中、ゲームオーバー管理
- **世界状態**: 地上/地獄の切り替え管理

### タスク7.2: 衝突判定とゲームオーバー【完了】
- **衝突検出**: プレイヤーと障害物の距離計算
- **ゲームオーバー処理**: BGM停止、効果音再生、UI切り替え
- **リセット機能**: 全状態の初期化、地上世界への強制復帰

---

## フェーズ8: 最適化と品質保証【完了】

### タスク8.1: パフォーマンス最適化【完了】
- **オブジェクト管理**: 画面外オブジェクトの適切な削除
- **メモリ管理**: Three.jsオブジェクトの正しい破棄処理
- **レンダリング**: 効率的なアニメーションループ

### タスク8.2: クロスプラットフォーム対応【完了】
- **PC対応**: 矢印キー操作
- **モバイル対応**: タッチスワイプ操作
- **音声対応**: iOS Safari、Android Chrome対応

### タスク8.3: エラーハンドリング【完了】
- **音声エラー**: 再生失敗時のコンソールログ出力
- **モデル読み込みエラー**: GLTFLoader エラーハンドリング
- **ゲーム状態エラー**: 不正な状態変更の防止

---

## 現在の実装状況

### ✅ 完了済み機能
- 基本ゲームプレイ（移動、障害物回避、スコア）
- 二世界システム（地上/地獄の切り替え）
- 多様なアイテムシステム（コイン、かぼちゃ、キャンディー、ポーション）
- フィーバータイムシステム
- パーティクルエフェクト
- 完全なBGM・SE音響システム
- モバイル音声対応
- クロスプラットフォーム対応

### 🔧 技術的特色
- **モジュール設計**: 保守性の高い8つのJSモジュール
- **モバイル音声最適化**: iOS/Android自動再生ポリシー対応
- **パフォーマンス**: 効率的なオブジェクト管理とメモリ使用
- **レスポンシブ**: PC/モバイル統一のゲーム体験

### 🎮 ゲーム仕様
- **操作**: 矢印キー（PC）/ スワイプ（モバイル）
- **世界**: 地上⇔地獄の動的切り替え
- **難易度**: 地獄世界で障害物生成率上昇
- **特殊効果**: フィーバータイム、パーティクル
- **音響**: 世界別BGM、多彩な効果音

---

## 今後の拡張可能性

### 🚀 追加検討要素
1. **新しい世界**: 氷の世界、宇宙世界など
2. **追加アイテム**: シールド、ジャンプブースターなど
3. **ランキングシステム**: オンラインスコア共有
4. **アチーブメント**: 達成目標システム
5. **モード選択**: エンドレス、タイムアタック、チャレンジ

### 📱 技術的改善案
1. **PWA対応**: オフライン対応、ホーム画面追加
2. **WebGL最適化**: より高度な3D効果
3. **音声拡張**: 3Dサウンド、動的音響効果
4. **AI要素**: 適応型難易度調整

---

## 最終評価

本プロジェクトは、**JavaScript + Three.js**による**フル機能3Dゲーム**として、以下の技術的成果を達成しています：

- ✅ **完全動作**: PC・モバイル両対応
- ✅ **音響システム**: モバイル自動再生ポリシー完全対応
- ✅ **3D表現**: 世界切り替え、パーティクルエフェクト
- ✅ **ゲーム性**: 多段階アイテム、フィーバータイム
- ✅ **コード品質**: モジュール設計、保守性

**リリース準備完了状態**に達しており、即座にWebデプロイ可能です。
